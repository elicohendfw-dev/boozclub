<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monthly Meetings</title>
  <meta name="description" content="BoozClub: monthly host and date." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#1e3a8a; --accent:#dc2626; --ring:rgba(220,38,38,.4);
      --shadow: 0 10px 20px rgba(0,0,0,.08); --radius: 18px;
      --btnBg:#bbf7d0; --btnText:#064e3b; --btnBorder:rgba(6,78,59,.35);
      --btnWarnBg:#fecaca; --btnWarnText:#7f1d1d; --btnWarnBorder:rgba(127,29,29,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
        --primary:#60a5fa; --accent:#ef4444; --ring:rgba(239,68,68,.35);
        --shadow: 0 10px 24px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:var(--text);
      background:radial-gradient(1000px 600px at 10% -10%, rgba(30,64,175,.10), transparent 60%),
                 radial-gradient(1200px 700px at 120% -20%, rgba(220,38,38,.10), transparent 50%), var(--bg);
    }
    .wrap{max-width:920px; margin:0 auto; padding:28px 20px 64px}
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0 24px; }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{ width:44px; height:44px; border-radius:12px; background: conic-gradient(from 210deg, rgba(30,64,175,.25), rgba(220,38,38,.25), rgba(30,64,175,.25)); display:grid; place-items:center; box-shadow:var(--shadow); position:relative; overflow:hidden; }
    .logo::after{content:""; position:absolute; inset:1px; border-radius:11px; background:linear-gradient(145deg, rgba(255,255,255,.1), rgba(0,0,0,.15)); mix-blend-mode: overlay}
    .brand h1{font-size:1.35rem; margin:0; letter-spacing:.3px}
    .brand small{display:block; color:var(--muted); font-weight:500; letter-spacing:.2px}

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(148,163,184,.18)}
    .hero{padding:26px; display:flex; align-items:center; justify-content:space-between; gap:18px; flex-wrap:wrap}
    .hero h2{font-size:1.1rem; margin:.25rem 0 0}
    .tag{display:inline-flex; align-items:center; gap:8px; font-size:.85rem; color:var(--muted)}
    .tag .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px var(--ring)}

    .status{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.75rem; color:var(--muted); border:1px solid rgba(148,163,184,.35)}

    .event{margin-top:16px; display:grid; grid-template-columns:1fr; gap:14px}
    .row{display:flex; align-items:center; gap:12px}
    .label{width:92px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.6px; font-size:.75rem}
    .value{font-size:1.05rem}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:18px}
    .btn{appearance:none; border:1px solid var(--btnBorder); background:var(--btnBg); color:var(--btnText); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn.primary{background:var(--btnBg); color:var(--btnText); border:1px solid var(--btnBorder)}
    .btn.warn{background:var(--btnWarnBg); color:var(--btnWarnText); border:1px solid var(--btnWarnBorder)}
    .btn.ghost{background:red; border:1px solid rgba(148,163,184,.35); color:var(--muted)}
    .btn:focus{outline:3px solid var(--ring); outline-offset:2px}

    .footnote{margin-top:14px; color:var(--muted); font-size:.9rem}

    /* Schedule UI tweaks */
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; border:1px solid rgba(148,163,184,.45)}
    .badge.skipped{border-color:var(--accent); color:var(--accent);}
    .badge.cancelled{border-color:var(--accent); color:var(--accent);}
    .row-skipped{opacity:.65}
    .row-active{color:var(--primary)}

    /* Full-bleed banner */
    .fullBleed{position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; width:100vw}
    .bannerImg{width:100%; height:clamp(220px, 30vw, 420px); object-fit:cover; display:block}
    .bannerOverlay{position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,0) 30%, rgba(0,0,0,.18))}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">üç∑</div>
        <div>
          <h1 id="clubName">BoozClub</h1>
          <small id="clubTag">Monthly Boozers Meet</small>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <span class="status" id="syncStatus">Loading‚Ä¶</span>
        <button class="btn" id="refreshBtn" title="Reload JSON">Refresh</button>
        <button class="btn warn" id="editEventsBtn" title="Edit events.json on GitHub">Edit Events</button>
        <button class="btn" id="shareBtn" title="Copy shareable summary">Share</button>
        <a class="btn ghost" href="./admin.html" title="Admin editor">Admin</a>
      </div>
    </header>

    <!-- Full-bleed banner image -->
    <div class="fullBleed banner">
      <img src="./boozers.png" alt="Assorted whiskey bottles on a shelf" class="bannerImg" loading="eager" fetchpriority="high">
      <div class="bannerOverlay" aria-hidden="true"></div>
    </div>

    <section class="card hero" aria-labelledby="nextEventHeading">
      <div>
        <span class="tag"><span class="dot" aria-hidden="true"></span> Next Gathering</span>
        <h2 id="nextEventHeading">See you soon üçª</h2>
        <div class="event">
          <div class="row"><div class="label">Host</div><div class="value" id="hostValue">‚Äî</div></div>
          <div class="row"><div class="label">Date</div><div class="value" id="dateValue">‚Äî</div></div>
        </div>
        <div class="actions">
          <button class="btn" id="calendarBtn">Save to Calendar (.ics)</button>
        </div>
        <p class="footnote" id="noteValue" style="display:none"></p>
      </div>
    </section>

    <!-- Schedule -->
    <section class="card" id="scheduleSection" aria-labelledby="scheduleHeading" style="margin-top:18px; display:none;">
      <div style="padding:18px">
        <h3 id="scheduleHeading" style="margin:0 0 8px 0; font-size:1rem">Schedule</h3>
        <div id="scheduleMount"></div>
      </div>
    </section>

    <footer class="footnote" style="margin-top:36px">
      Edit the schedule via <b>Admin</b> (top-right) or directly in <code>events.json</code>. Click <b>Refresh</b> to pull updates.
    </footer>
  </div>

  <script>
    // --- Config ---
    const KEY = 'boozclub_event_v4'; // cache key (no PIN/editor now)
    const GH = { user:'elicohendfw-dev', repo:'boozclub', branch:'main' };
    const EVENT_PATH = './event.json';
    const EVENTS_PATH = './events.json';
    const RAW_BASE = `https://raw.githubusercontent.com/${GH.user}/${GH.repo}/${GH.branch}`;
    const EVENT_RAW = `${RAW_BASE}/event.json`;
    const EVENTS_RAW = `${RAW_BASE}/events.json`;

    // --- Defaults (no PIN / no local editor) ---
    const DEFAULTS = {
      clubName:'BoozClub',
      clubTag:'Monthly Boozers Meet',
      host:'TBD',
      date:new Date().toISOString().slice(0,10),
      note:''
    };

    // --- Elements ---
    const el = {
      clubName: document.getElementById('clubName'),
      clubTag: document.getElementById('clubTag'),
      host: document.getElementById('hostValue'),
      date: document.getElementById('dateValue'),
      note: document.getElementById('noteValue'),
      shareBtn: document.getElementById('shareBtn'),
      calBtn: document.getElementById('calendarBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      editEventsBtn: document.getElementById('editEventsBtn'),
      sync: document.getElementById('syncStatus'),
      scheduleSection: document.getElementById('scheduleSection'),
      scheduleMount: document.getElementById('scheduleMount')
    };

    // --- State / bootstrap ---
    const state = loadCache();
    inferRepoFromLocation();
    render();
    syncFromRemote(false);

    // --- Cache helpers (kept for quick loads/offline fallback) ---
    function loadCache(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? { ...DEFAULTS, ...JSON.parse(raw) } : { ...DEFAULTS };
      }catch{ return { ...DEFAULTS }; }
    }

    // --- Render ---
    function render(){
      el.clubName.textContent = state.clubName;
      el.clubTag.textContent = state.clubTag;
      el.host.textContent = state.host || 'TBD';
      el.date.textContent = formatDate(state.date);
      if(state.note && state.note.trim().length){
        el.note.style.display = 'block'; el.note.textContent = state.note.trim();
      } else {
        el.note.style.display = 'none';
      }
      document.getElementById('nextEventHeading').textContent = `Hosted by ${state.host || 'TBD'}`;
    }

    // --- Sync from central JSON (schedule first, then single event) ---
    async function syncFromRemote(force){
      setStatus('Loading‚Ä¶', 'loading');
      const qs = force ? `?t=${Date.now()}` : '';
      let loaded = false, used = '';

      try{
        const sched = await fetchChain([EVENTS_PATH + qs, EVENTS_RAW]);
        if (sched && Array.isArray(sched.events)){
          applySchedule(sched.events);
          loaded = true; used = 'events';
        }
      }catch{}

      if(!loaded){
        try{
          const single = await fetchChain([EVENT_PATH + qs, EVENT_RAW]);
          Object.assign(state, { ...DEFAULTS, ...single });
          loaded = true; used = 'event';
        }catch{}
      }

      if(loaded){
        try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch{}
        render();
        setStatus(used==='events' ? 'Synced (schedule)' : 'Synced', 'ok');
      } else {
        setStatus('Offline / using cache', 'warn');
      }
    }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status+' '+url);
      return res.json();
    }
    async function fetchChain(urls){
      let lastErr = null;
      for(const u of urls){
        try{ return await fetchJSON(u); } catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('All fetches failed');
    }

    function applySchedule(events){
      const norm = events
        .map(e => ({ date: (e.date||'').slice(0,10), host: e.host || '', note: e.note || '' }))
        .filter(e=> e.date)
        .sort((a,b)=> a.date.localeCompare(b.date));

      const today = new Date().toISOString().slice(0,10);
      const next = norm.find(e => {
        const n=(e.note||'').toLowerCase();
        return e.date >= today && !n.includes('skipp') && !n.includes('cancel');
      }) || norm[norm.length-1];

      if(next){
        Object.assign(state, { host: next.host, date: next.date, note: next.note || '' });
      }
      renderSchedule(norm);
    }

    function classifyEvent(e){
      const n=(e.note||'').toLowerCase();
      const isSkipped = n.includes('skipp');
      const isCancelled = n.includes('cancel');
      return { isSkipped, isCancelled, rowClass: (isSkipped || isCancelled) ? 'row-skipped' : 'row-active' };
    }

    function renderSchedule(list){
      if(!Array.isArray(list) || !list.length){ el.scheduleSection.style.display = 'none'; return; }
      const rows = list.map(e=>{
        const { isSkipped, isCancelled, rowClass } = classifyEvent(e);
        const noteCell = isSkipped
          ? `<span class="badge skipped">Skipped</span>`
          : isCancelled
          ? `<span class="badge cancelled">Cancelled</span>`
          : (e.note||'');
        const hostRaw = (e.host||'').trim().toLowerCase();
        const hideHost = isSkipped || hostRaw==='skip' || hostRaw==='skipped' || hostRaw==='cancelled' || hostRaw==='canceled';
        const hostCell = hideHost ? '‚Äî' : (e.host || '‚Äî');
        return `<tr class="${rowClass}">
          <td>${formatDate(e.date)}</td>
          <td>${hostCell}</td>
          <td>${noteCell}</td>
        </tr>`;
      }).join('');
      el.scheduleMount.innerHTML = `<div style="overflow:auto"><table style="width:100%; border-collapse:collapse">
        <thead><tr>
          <th style="text-align:left; padding:8px 6px; border-bottom:1px solid rgba(148,163,184,.35)">Date</th>
          <th style="text-align:left; padding:8px 6px; border-bottom:1px solid rgba(148,163,184,.35)">Host</th>
          <th style="text-align:left; padding:8px 6px; border-bottom:1px solid rgba(148,163,184,.35)">Note</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
      el.scheduleSection.style.display = '';
    }

    // --- UI helpers ---
    function setStatus(text, tone){
      el.sync.textContent = text;
      el.sync.style.borderColor = tone==='ok' ? 'rgba(22,163,74,.45)'
        : tone==='warn' ? 'rgba(234,179,8,.55)'
        : 'rgba(148,163,184,.35)';
    }
    function formatDate(yyyy_mm_dd){
      if(!yyyy_mm_dd) return '‚Äî';
      const [y,m,d] = yyyy_mm_dd.split('-').map(Number);
      const dt = new Date(y, (m||1)-1, d||1);
      return dt.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
    }

    // --- Buttons ---
    el.shareBtn.addEventListener('click', async ()=>{
      const text = `BoozClub ‚Äî Next Gathering\nHost: ${state.host}\nDate: ${formatDate(state.date)}${state.note?`\nNote: ${state.note}`:''}`;
      if (navigator.share) {
        try { await navigator.share({ text }); } catch {}
      } else {
        try { await navigator.clipboard.writeText(text); alert('Summary copied'); } catch { alert('Copy failed'); }
      }
    });
    el.calBtn.addEventListener('click', ()=>{
      const ics = buildICS();
      const blob = new Blob([ics], { type:'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `BoozClub-${state.date}.ics`; a.click();
      URL.revokeObjectURL(url);
    });
    el.refreshBtn.addEventListener('click', ()=> syncFromRemote(true));
    el.editEventsBtn.addEventListener('click', ()=>{
      const url = getGithubEditURL('events.json');
      if(url){ window.open(url, '_blank'); } else { alert('Set your GitHub repo.'); }
    });

    // --- ICS ---
    function buildICS(){
      const [y,m,d] = (state.date || '').split('-').map(Number);
      const pad = (n)=> String(n).padStart(2,'0');
      const ymd = `${String(y).padStart(4,'0')}${pad(m||1)}${pad(d||1)}`;
      const startLocal = `${ymd}T190000`; // 7pm
      const endLocal   = `${ymd}T210000`; // 9pm
      const now = new Date();
      const fmtStamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      return [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//BoozClub//Event//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
        `UID:${Date.now()}@boozclub.local`,
        `DTSTAMP:${fmtStamp}`,
        `DTSTART;TZID=America/Chicago:${startLocal}`,
        `DTEND;TZID=America/Chicago:${endLocal}`,
        'SUMMARY:' + escapeICS('BoozClub Meeting at ' + (state.host || 'TBD')),
        `DESCRIPTION:${escapeICS(state.note || 'Monthly tasting')}`,
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
    }
    function escapeICS(str){
      return String(str)
        .replace(/\\/g, '\\\\')
        .replace(/\n/g, '\\n')
        .replace(/,/g, '\\,')
        .replace(/;/g, '\\;');
    }

    // --- GitHub helpers ---
    function inferRepoFromLocation(){
      try{
        const host = location.hostname; const pathSegs = location.pathname.split('/').filter(Boolean);
        if(host.endsWith('github.io')){ GH.user = host.split('.')[0]; GH.repo = pathSegs.length ? pathSegs[0] : `${GH.user}.github.io`; }
      }catch{}
    }
    function getGithubEditURL(file){
      if(!GH.user || !GH.repo) return '';
      const f = file || 'events.json';
      return `https://github.com/${GH.user}/${GH.repo}/edit/${GH.branch}/${f}`;
    }

    // --- Minimal self-tests (console) ---
    (function runSelfTests(){
      const tests = []; const ok = (name, cond)=> tests.push({ name, pass: !!cond });
      const sample = 'a,b;c\\d\nline'; const escaped = escapeICS(sample);
      ok('escapeICS escapes , ; \\ and newline', escaped === 'a\\,b\\;c\\\\d\\nline');
      const ics = buildICS(); ok('ICS sections', /BEGIN:VCALENDAR/.test(ics) && /BEGIN:VEVENT/.test(ics) && /END:VEVENT/.test(ics) && /END:VCALENDAR/.test(ics));
      ok('ICS time 7‚Äì9pm CT', /DTSTART;TZID=America\/Chicago:\d{8}T190000/.test(ics) && /DTEND;TZID=America\/Chicago:\d{8}T210000/.test(ics));
      ok('Edit URL ok', getGithubEditURL('events.json').endsWith('/events.json'));
      ok('Row class logic', classifyEvent({note:''}).rowClass==='row-active' && classifyEvent({note:'Skipped'}).rowClass==='row-skipped' && classifyEvent({note:'Cancelled'}).rowClass==='row-skipped');
      const failed = tests.filter(t=>!t.pass); if (failed.length){ console.warn('[BoozClub tests] FAILED', failed); } else { console.log('[BoozClub tests] All tests passed'); }
    })();
  </script>
</body>
</html>
