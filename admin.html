<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BoozClub ‚Äì Admin</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#1e3a8a; --accent:#dc2626; --ring:rgba(30,64,175,.35);
      --shadow:0 10px 20px rgba(0,0,0,.08); --radius:16px;
      --btn:#bbf7d0; --btnText:#064e3b; --btnBorder:rgba(6,78,59,.35);
      --warn:#fecaca; --warnText:#7f1d1d; --warnBorder:rgba(127,29,29,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#60a5fa; --accent:#ef4444; --shadow:0 10px 24px rgba(0,0,0,.35); }
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; color:var(--text);
      background:radial-gradient(900px 520px at 10% -10%, rgba(30,64,175,.10), transparent 60%),
                 radial-gradient(1100px 620px at 120% -20%, rgba(220,38,38,.10), transparent 50%), var(--bg);}
    .wrap{max-width:980px; margin:0 auto; padding:24px 18px 56px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:conic-gradient(from 210deg, rgba(30,64,175,.25), rgba(220,38,38,.25), rgba(30,64,175,.25)); box-shadow:var(--shadow)}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(148,163,184,.18); padding:16px; margin-top:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--btnBorder); background:var(--btn); color:var(--btnText); padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn.warn{background:var(--warn); color:var(--warnText); border-color:var(--warnBorder)}
    .btn.ghost{background:transparent; border-color:rgba(148,163,184,.35); color:var(--muted)}
    .status{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.8rem; color:var(--muted); border:1px solid rgba(148,163,184,.35)}
    input, select, textarea{ font:inherit; padding:8px 10px; border-radius:10px; border:1px solid rgba(148,163,184,.35); background:var(--bg); color:var(--text) }
    table{width:100%; border-collapse:collapse}
    th, td{ text-align:left; padding:8px 6px; border-bottom:1px solid rgba(148,163,184,.28) }
    tbody tr:hover{ background:rgba(30,64,175,.06) }
    .noteBadge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; border:1px solid rgba(148,163,184,.45)}
    .muted{color:var(--muted)}
    .hint{color:var(--muted); font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üç∑</div>
        <div>
          <h1 style="margin:0; font-size:1.2rem">BoozClub ‚Äì Admin</h1>
          <div class="hint">Edit <code>events.json</code> with a form (no raw JSON)</div>
        </div>
      </div>
      <a class="btn ghost" href="./" title="Back to site">‚Üê Back to site</a>
    </header>

    <!-- Auth -->
    <section class="card">
      <div class="row">
        <div class="status" id="authStatus">Not signed in</div>
        <label class="hint">Repo: <code id="repoLabel">elicohendfw-dev/boozclub@main</code></label>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="tokenInput" type="password" placeholder="GitHub token (repo scope or public_repo)" style="min-width:320px" />
        <button class="btn" id="signInBtn">Sign in</button>
        <button class="btn ghost" id="signOutBtn">Sign out</button>
        <button class="btn" id="loadBtn" title="Fetch current events.json">Load from GitHub</button>
        <button class="btn" id="saveBtn" title="Commit changes to GitHub">Save to GitHub</button>
        <button class="btn ghost" id="downloadBtn" title="Download a backup JSON">Download JSON</button>
      </div>
      <p class="hint" style="margin-top:8px">Your token is kept in <b>sessionStorage</b> on this browser only (cleared on tab close). Create a fine-scoped token for this repo if possible.</p>
    </section>

    <!-- Hosts -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0;font-size:1rem">Host List</h3>
        <div class="hint">Used to populate the Host dropdown</div>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="hostsInput" rows="4" style="width:100%" placeholder="One host per line"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveHostsBtn">Save Host List (local)</button>
        <button class="btn ghost" id="resetHostsBtn">Reset to defaults</button>
      </div>
    </section>

    <!-- Events -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0;font-size:1rem">Events</h3>
        <div class="row">
          <button class="btn" id="addRowBtn">Add Row</button>
          <button class="btn ghost" id="sortBtn">Sort by Date</button>
        </div>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead>
            <tr>
              <th style="width:160px">Date</th>
              <th>Host</th>
              <th style="width:160px">Note</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // --- Config ---
    const GH = { user:'elicohendfw-dev', repo:'boozclub', branch:'main' };
    const FILE_PATH = 'events.json';
    const STORAGE = { token:'booz_admin_token_v1', hosts:'booz_admin_hosts_v1', sha:'booz_admin_events_sha_v1' };

    // --- Elements ---
    const el = {
      authStatus: document.getElementById('authStatus'),
      repoLabel: document.getElementById('repoLabel'),
      token: document.getElementById('tokenInput'),
      signIn: document.getElementById('signInBtn'),
      signOut: document.getElementById('signOutBtn'),
      load: document.getElementById('loadBtn'),
      save: document.getElementById('saveBtn'),
      download: document.getElementById('downloadBtn'),
      hostsInput: document.getElementById('hostsInput'),
      saveHosts: document.getElementById('saveHostsBtn'),
      resetHosts: document.getElementById('resetHostsBtn'),
      addRow: document.getElementById('addRowBtn'),
      sort: document.getElementById('sortBtn'),
      tbody: document.getElementById('tbody'),
    };

    // --- State ---
    let EVENTS = []; // [{date, host, note}]
    let HOSTS = loadHosts();

    // --- Init ---
    el.repoLabel.textContent = `${GH.user}/${GH.repo}@${GH.branch}`;
    el.hostsInput.value = HOSTS.join('\n');
    const savedToken = sessionStorage.getItem(STORAGE.token) || '';
    if(savedToken){ el.token.value = mask(savedToken); setAuthStatus(true); }

    // --- Events ---
    el.signIn.addEventListener('click', ()=>{
      const t = el.token.value.trim();
      if(!t){ alert('Paste a GitHub token'); return; }
      // Allow masked token to persist across reload of this page; if masked, do nothing
      if(t.includes('‚Ä¢‚Ä¢‚Ä¢')){ setAuthStatus(true); return; }
      sessionStorage.setItem(STORAGE.token, t);
      setAuthStatus(true);
    });
    el.signOut.addEventListener('click', ()=>{ sessionStorage.removeItem(STORAGE.token); setAuthStatus(false); });

    el.saveHosts.addEventListener('click', ()=>{
      HOSTS = el.hostsInput.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      localStorage.setItem(STORAGE.hosts, JSON.stringify(HOSTS));
      render();
      alert('Host list saved locally.');
    });
    el.resetHosts.addEventListener('click', ()=>{
      HOSTS = defaultHosts();
      localStorage.setItem(STORAGE.hosts, JSON.stringify(HOSTS));
      el.hostsInput.value = HOSTS.join('\n');
      render();
    });

    el.addRow.addEventListener('click', ()=>{ EVENTS.push({ date:'', host:'', note:'' }); render(); scrollToBottom(); });
    el.sort.addEventListener('click', ()=>{ EVENTS.sort((a,b)=>(a.date||'').localeCompare(b.date||'')); render(); });

    el.load.addEventListener('click', loadFromGitHub);
    el.save.addEventListener('click', saveToGitHub);
    el.download.addEventListener('click', ()=>{
      const data = buildJSON();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'events.json'; a.click(); URL.revokeObjectURL(url);
    });

    // --- Rendering ---
    function render(){
      el.tbody.innerHTML = EVENTS.map((e, i)=> rowHTML(e, i)).join('');
      // bind inputs after render
      EVENTS.forEach((e, i)=> bindRow(i));
    }
    function rowHTML(e, i){
      return `<tr>
        <td><input type="date" value="${escapeHtml(e.date||'')}" data-idx="${i}" data-key="date"></td>
        <td>${hostSelectHTML(e.host||'', i)}</td>
        <td>${noteSelectHTML(e.note||'', i)}</td>
        <td><button class="btn warn" data-action="del" data-idx="${i}">Delete</button></td>
      </tr>`;
    }
    function hostSelectHTML(value, i){
      const options = ['','Other‚Ä¶',...HOSTS];
      const opts = options.map(v=>{
        const label = v||'(blank)';
        const selected = (v === value) ? ' selected' : '';
        return `<option value="${escapeHtml(v)}"${selected}>${escapeHtml(label)}</option>`;
      }).join('');
      return `<select data-idx="${i}" data-key="host">${opts}</select>`;
    }
    function noteSelectHTML(value, i){
      const opts = [
        {v:'', l:'(blank)'},
        {v:'Skipped', l:'Skipped'},
        {v:'Cancelled', l:'Cancelled'}
      ].map(o=>`<option value="${o.v}"${o.v===value?' selected':''}>${o.l}</option>`).join('');
      return `<select data-idx="${i}" data-key="note">${opts}</select>`;
    }
    function bindRow(i){
      const inputs = el.tbody.querySelectorAll(`[data-idx="${i}"]`);
      inputs.forEach(inp=>{
        if(inp.dataset.action === 'del') return;
        inp.addEventListener('change', (ev)=>{
          const k = inp.dataset.key;
          let v = inp.value;
          if(k === 'host' && v === 'Other‚Ä¶'){
            const custom = prompt('Enter host name');
            v = (custom||'').trim();
            if(!v){ inp.value = ''; v = ''; }
            else {
              // Add to list if not present
              if(!HOSTS.includes(v)){ HOSTS.push(v); HOSTS.sort((a,b)=>a.localeCompare(b)); el.hostsInput.value = HOSTS.join('\n'); localStorage.setItem(STORAGE.hosts, JSON.stringify(HOSTS)); }
              inp.innerHTML = hostSelectHTML(v, i).replace(/^<select[^>]*>|<\/select>$/g, '');
              inp.value = v;
            }
          }
          EVENTS[i][k] = v;
        });
      });
      const delBtn = el.tbody.querySelector(`[data-action="del"][data-idx="${i}"]`);
      delBtn.addEventListener('click', ()=>{ EVENTS.splice(i,1); render(); });
    }

    // --- GitHub API ---
    async function loadFromGitHub(){
      try{
        setStatus('Loading from GitHub‚Ä¶');
        const res = await ghGET(`/repos/${GH.user}/${GH.repo}/contents/${FILE_PATH}?ref=${GH.branch}`);
        const json = await res.json();
        if(res.status !== 200) throw new Error(`${res.status} ${json.message||res.statusText}`);
        const content = atob((json.content||'').replace(/\n/g,''));
        const data = JSON.parse(content || '{}');
        if(!data || !Array.isArray(data.events)) throw new Error('events.json missing { events: [] }');
        EVENTS = data.events.map(e=>({ date:(e.date||'').slice(0,10), host:e.host||'', note:e.note||'' }));
        sessionStorage.setItem(STORAGE.sha, json.sha||'');
        render();
        setStatus('Loaded ‚úì');
      }catch(err){ console.error(err); alert('Load failed: ' + err.message); setStatus('Load failed'); }
    }
    async function saveToGitHub(){
      try{
        const token = sessionStorage.getItem(STORAGE.token);
        if(!token){ alert('Sign in with a GitHub token first.'); return; }
        setStatus('Committing‚Ä¶');
        const body = JSON.stringify(buildJSON(), null, 2);
        const b64 = btoa(unescape(encodeURIComponent(body)));
        // Ensure we have latest sha
        let sha = sessionStorage.getItem(STORAGE.sha)||'';
        if(!sha){
          const head = await ghGET(`/repos/${GH.user}/${GH.repo}/contents/${FILE_PATH}?ref=${GH.branch}`);
          const headJson = await head.json();
          if(head.status === 200) sha = headJson.sha||'';
        }
        const putRes = await fetch(`https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${FILE_PATH}`,
          { method:'PUT', headers: ghHeaders(true), body: JSON.stringify({ message:`chore: update ${FILE_PATH} via admin.html`, content:b64, branch:GH.branch, sha }) });
        const out = await putRes.json();
        if(putRes.status >= 400) throw new Error(`${putRes.status} ${out.message||putRes.statusText}`);
        sessionStorage.setItem(STORAGE.sha, out.content && out.content.sha ? out.content.sha : '');
        setStatus('Committed ‚úì');
        alert('Saved to GitHub. Go to the public page and click Refresh.');
      }catch(err){ console.error(err); alert('Save failed: ' + err.message); setStatus('Save failed'); }
    }
    function ghHeaders(auth){
      const h = { 'Accept':'application/vnd.github+json', 'X-GitHub-Api-Version':'2022-11-28' };
      if(auth){ const t = sessionStorage.getItem(STORAGE.token)||''; if(t) h['Authorization'] = `token ${t}`; }
      return h;
    }
    function ghGET(path){ return fetch(`https://api.github.com${path}`, { headers: ghHeaders(true), cache:'no-store' }); }

    // --- Helpers ---
    function buildJSON(){
      const clean = EVENTS
        .map(e=>({ date:(e.date||'').slice(0,10), host:(e.host||'').trim(), note:(e.note||'').trim() }))
        .filter(e=> e.date); // keep only rows with a date
      clean.sort((a,b)=> a.date.localeCompare(b.date));
      return { events: clean };
    }
    function loadHosts(){
      try{ const raw = localStorage.getItem(STORAGE.hosts); if(raw) return JSON.parse(raw); }catch{}
      return defaultHosts();
    }
    function defaultHosts(){
      return [
        'Tom Cooksey','Russell Stover','Tom Liggett','Mike Petersen','Steve Farr','Eli Cohen','Randy Riley','John Ramsey','Bill Farr','Paul Lazzara'
      ];
    }
    function setStatus(text){ el.authStatus.textContent = text; }
    function setAuthStatus(authed){ el.authStatus.textContent = authed? 'Signed in' : 'Not signed in'; }
    function scrollToBottom(){ window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' }); }
    function mask(t){ return t ? t.slice(0,4)+'‚Ä¢‚Ä¢‚Ä¢'+t.slice(-4) : ''; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }

    // --- Self tests (console) ---
    (function tests(){
      const T=[]; const ok=(n,c)=>T.push({n,pass:!!c});
      // sorting
      const j = { events:[{date:'2025-02-01'},{date:'2025-01-01'},{date:''}] };
      EVENTS = j.events.map(e=>({date:e.date||'', host:'', note:''}));
      const out = buildJSON(); ok('sort asc', out.events[0].date==='2025-01-01' && out.events[1].date==='2025-02-01');
      // hosts persistence
      const before = HOSTS.length; HOSTS.push('Zed'); localStorage.setItem(STORAGE.hosts, JSON.stringify(HOSTS)); HOSTS = loadHosts(); ok('hosts persist', HOSTS.includes('Zed'));
      // note options
      ok('note options fixed', ['','Skipped','Cancelled'].every(v=> noteSelectHTML(v,0).includes(`value="${v}"`)) );
      if(T.some(t=>!t.pass)) console.warn('[admin tests] FAILED', T); else console.log('[admin tests] All tests passed');
    })();
  </script>
</body>
</html>

